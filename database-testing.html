<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2014-07-09 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20140709" />
    <meta http-equiv="Content-Language" content="en" />
    <title>needle4j - hhh - Database Testing</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.1.min.js"></script>

    
                  </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="http://github.com/needle4j/needle4j">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>needle4j</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2014-07-09
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 2.3
                          <span class="divider">|</span>
                      </li>
                                          <li class="">
                    <a href="./" title="Home">
        Home</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Database Testing</li>
                
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Main</li>
                              
      <li>
  
                          <a href="index.html" title="Overview">
          <i class="none"></i>
        Overview</a>
            </li>
                
      <li>
  
                          <a href="license.html" title="License">
          <i class="none"></i>
        License</a>
            </li>
                              <li class="nav-header">Documentation</li>
                              
      <li>
  
                          <a href="getting-started.html" title="Getting started">
          <i class="none"></i>
        Getting started</a>
            </li>
                
      <li>
  
                          <a href="configuration.html" title="Configuration">
          <i class="none"></i>
        Configuration</a>
            </li>
                
      <li>
  
                          <a href="needle-testcase.html" title="Needle Testcase">
          <i class="none"></i>
        Needle Testcase</a>
            </li>
                
      <li class="active">
  
            <a href="#"><i class="none"></i>Database Testing</a>
          </li>
                
      <li>
  
                          <a href="mock-objectsg.html" title="Testing with Mock objects">
          <i class="none"></i>
        Testing with Mock objects</a>
            </li>
                              <li class="nav-header">Development</li>
                              
      <li>
  
                          <a href="apidocs/index.html" title="JavaDoc">
          <i class="none"></i>
        JavaDoc</a>
            </li>
                
      <li>
  
                          <a href="http://github.com/needle4j/needle4j/" class="externalLink" title="GitHub project">
          <i class="none"></i>
        GitHub project</a>
            </li>
                
      <li>
  
                          <a href="issue-tracking.html" title="Issue tracking">
          <i class="none"></i>
        Issue tracking</a>
            </li>
                
      <li>
  
                          <a href="project-info.html" title="Project info">
          <i class="none"></i>
        Project info</a>
            </li>
                
      <li>
  
                          <a href="project-reports.html" title="project-reports">
          <i class="none"></i>
        project-reports</a>
            </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Database Testing</h1>
<p>When unit-testing your application, it is usually recommended to mock calls to DAOs oder database dependent services in your test cases. However, you will also need to test against a real database, e.g. to make sure that your queries work as expected.</p>
<div class="section">
<h2>Database Testcase<a name="Database_Testcase"></a></h2>
<p>In these cases, Needle can automatically create and inject the <tt>EntityManager</tt> instance into your objects under test. You simply need to provide a JPA persistence.xml and the JDBC driver to the classpath of the test execution. The <tt>persistence.xml</tt> file is the standard configuration file in JPA. The <tt>persistence.xml</tt> file must define a persistence-unit with a unique name and the transaction type RESOURCE_LOCAL for a Java SE environment.</p>
<p>The following listing below shows a complete example of a <tt>persistence.xml</tt> file.</p>

<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;persistence xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
   xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;
   version=&quot;2.0&quot; xmlns=&quot;http://java.sun.com/xml/ns/persistence&quot;&gt;
   &lt;persistence-unit name=&quot;TestDataModel&quot; transaction-type=&quot;RESOURCE_LOCAL&quot;&gt;

   &lt;class&gt;fqn.User&lt;/class&gt;
   &lt;class&gt;fqn.Profile&lt;/class&gt;

   &lt;properties&gt;
     &lt;property name=&quot;javax.persistence.jdbc.driver&quot; value=&quot;org.hsqldb.jdbcDriver&quot; /&gt;
     &lt;property name=&quot;javax.persistence.jdbc.url&quot; value=&quot;jdbc:hsqldb:.&quot; /&gt;
     &lt;property name=&quot;javax.persistence.jdbc.user&quot; value=&quot;sa&quot; /&gt;
     &lt;property name=&quot;javax.persistence.jdbc.password&quot; value=&quot;&quot; /&gt;
     &lt;!-- EclipseLink should create the database schema automatically --&gt;
     &lt;property name=&quot;eclipselink.ddl-generation&quot; value=&quot;create-tables&quot; /&gt;
     &lt;property name=&quot;eclipselink.ddl-generation.output-mode&quot; value=&quot;database&quot; /&gt;
   &lt;/properties&gt;

   &lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre></div>
<p>The UserTest below checks the JPA mapping against a real database.</p>

<div class="source">
<pre>public class UserTest {
  @Rule
  public DatabaseRule databaseRule = new DatabaseRule();

  @Test
  public void testPersist() throws Exception {
    EntityManager entityManager = databaseRule.getEntityManager();
    User user = new UserTestdataBuilder(entityManager).buildAndSave();
    User userFromDb = entityManager.find(User.class, user.getId());
    Assert.assertEquals(user.getId(), userFromDb.getId());
  }
}
</pre></div>
<p>Note: The persistence context is cleared after each test!</p></div>
<div class="section">
<h2>Transaction utilities<a name="Transaction_utilities"></a></h2>
<p>The EntityManager is the primary interface used by application developers to interact with the underlying database. Many operations must be executed in a transaction which is not started in the test component, because it is usually maintained by the application server. To run your code using transactions the <tt>TransactionHelper</tt> Utility makes this more convenient.</p>

<div class="source">
<pre>public class UserTest {
  @Rule
  public DatabaseRule databaseRule = new DatabaseRule();
       
  private TransactionHelper transactionHelper = databaseRule.getTransactionHelper();

  @Test
  public void testPersist() throws Exception {
    final User user = new User();
    ... 
    transactionHelper.executeInTransaction(new VoidRunnable() {
      @Override
      public void doRun(EntityManager entityManager) throws Exception {
        entityManager.persist(user);
      }
    });   
  }
 }
</pre></div>
<p>The above example illustrates the use of the <tt>TransactionHelper</tt> class and the execution of a transaction. The implementation of the VoidRunnable is executed within a transaction. There is also <tt>Runnable&lt;T&gt;</tt> interface that contains a method run return a value to be used for further testing.</p></div>
<div class="section">
<h2>Database operation<a name="Database_operation"></a></h2>
<p>A common issue in unit tests that access a real database is their effect on the state of the persistence store. They usually expect a certain state at the beginning and alter it at runtime which of course will affect other tests. To address that problem optional Database operations can be executed before and after test execution, in order to clean up or set up data.</p>
<p>There are the following implementations:</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th>Class </th>
      
<th>Description</th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td>org.needle4j.db.operation.ExecuteScriptOperation </td>
      
<td>Execute sql scripts during test setup and tear down. A before.sql and after.sql script must be provided on the classpath.</td>
    </tr>
    
<tr class="a">
      
<td>org.needle4j.db.operation.h2.H2DeleteOperation </td>
      
<td>Deletes all rows of all tables of the h2 database.</td>
    </tr>
    
<tr class="b">
      
<td>org.needle4j.db.operation.hsql.HSQLDeleteOperation` </td>
      
<td>Deletes all rows of all tables of the hsql database.</td>
    </tr>
  </tbody>
</table>
<p>To use own Database operation implementations, the abstract base class <tt>org.needle4j.db.operation.AbstractDBOperation</tt> must be implemented and configured in the <tt>needle.properties</tt> file.</p></div>
<div class="section">
<h2>Testdatabuilder<a name="Testdatabuilder"></a></h2>
<p>Using the Test Data Builder pattern, the builder class provides methods that can be used to configure the test objects. Properties that are not configured use default values. The builder methods can be chained together and provide transient or persistent testdata for the test case.</p>
<p>For this purpose Needle provides an abstract base class. The following code examples shows two implementations of Test Data Builder pattern. The Testdatabuilder inherit from &#x2018;org.needle4j.db.testdata.AbstractTestdataBuilder&#x2019; class.</p>

<div class="source">
<pre>public class UserTestdataBuilder extends AbstractTestdataBuilder&lt;User&gt; {

  private String withUsername;
  private String withPassword;
  private Profile withProfile;

  public UserTestdataBuilder() {
    super();
  }

  public UserTestdataBuilder(EntityManager entityManager) {
    super(entityManager);
  }

  public UserTestdataBuilder withUsername(final String username) {
    this.withUsername = username;
    return this;
  }

  private String getUsername() {
    return withUsername != null ? withUsername : &quot;username&quot;;
  }

  public UserTestdataBuilder withPassword(final String password) {
    this.withPassword = password;
    return this;
  }

  private String getPassword() {
    return withPassword != null ? withPassword : &quot;password&quot;;
  }

  public UserTestdataBuilder withProfile(final Profile profile) {
    this.withProfile = profile;
    return this;
  }

  private Profile getProfile() {
    if (withProfile != null) {
      return withProfile;
    }
    return hasEntityManager() 
           ? new ProfileTestdataBuilder(getEntityManager()).buildAndSave()
           : new ProfileTestdataBuilder().build();
  }

  @Override
  public User build() {
     User user = new User();
     user.setUsername(getUsername());
     user.setPassword(getPassword());
     user.setProfile(getProfile());
     return user;
  }
}
</pre></div>

<div class="source">
<pre>public class ProfileTestdataBuilder extends AbstractTestdataBuilder&lt;Profile&gt; {

  private String withLanguage;
       
  public ProfileTestdataBuilder() {
    super();
  }

  public ProfileTestdataBuilder(EntityManager entityManager) {
    super(entityManager);
  }

  public ProfileTestdataBuilder withLanguage(final String language) {
    this.withLanguage = language;
    return this;
  }

  private String getLanguage() {
    return withLanguage != null ? withLanguage : &quot;de&quot;;
  }

  @Override
  public Profile build() {
    Profile profile = new Profile();
    profile.setLanguage(getLanguage());
    return profile;
  }
}
</pre></div>
<p>In the example the Testdatabuilder is using defaults for everything except the username.</p>

<div class="source">
<pre>final User user = new UserTestdataBuilder(databaseRule.getEntityManager()).withUsername(&quot;user&quot;).buildAndSave();

final User user = new UserTestdataBuilder().withUsername(&quot;user&quot;).build()
</pre></div></div>
<div class="section">
<h2>Injectable database resources<a name="Injectable_database_resources"></a></h2>
<p>In combination with the NeedleRule, the following resources are injectable by the DatabaseTestcase.</p>

<ol style="list-style-type: decimal">
  
<li>EntityManager</li>
  
<li>EntityManagerFactory</li>
  
<li>EntityTransaction</li>
  
<li>TransactionHelper</li>
</ol>
<p>Example:</p>

<div class="source">
<pre>public class UserDaoTest{
        
  @Rule
  public NeedleRule needleRule = new NeedleRule().withOuter(new DatabaseRule());        
  //  Alternative:
  // 
  //  @Rule
  //  public DatabaseRule dbRule = new DatabaseRule()
  //  @Rule
  //  public NeedleRule needleRule = new NeedleRule(dbRule);
       
  @Inject
  private EntityManager entityManager;

  @Inject
  private EntityTransaction entityTransaction;
  //&#x2026;
}
</pre></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                   2014.
          All rights reserved.      
                    
      </p>
        </div>

        
        
                </div>
    </footer>
        </body>
</html>
